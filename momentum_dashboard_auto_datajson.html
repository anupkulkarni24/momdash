<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Momentum Dashboard â€“ Intraday, Swing & Positional</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b1020;
      --bg-card: #111729;
      --bg-alt: #151b30;
      --accent: #38bdf8;
      --accent-soft: rgba(56,189,248,0.12);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #f97373;
      --border: #1f2937;
      --radius-lg: 14px;
      --radius-sm: 8px;
      --shadow-soft: 0 18px 40px rgba(0,0,0,0.45);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 55%);
      color: var(--text);
      min-height: 100vh;
    }

    .page {
      max-width: 1280px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 18px;
    }

    .title-block h1 {
      margin: 0;
      font-size: 1.8rem;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tag-pill {
      font-size: 0.7rem;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid var(--accent-soft);
      color: var(--accent);
      background: rgba(15,23,42,0.8);
    }

    .subtitle {
      margin: 4px 0 0;
      font-size: 0.86rem;
      color: var(--muted);
      max-width: 640px;
    }

    .upload-card {
      background: radial-gradient(circle at top left, rgba(56,189,248,0.18), rgba(15,23,42,0.9));
      border-radius: var(--radius-lg);
      padding: 10px 14px;
      border: 1px solid rgba(148,163,184,0.35);
      box-shadow: var(--shadow-soft);
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .upload-card label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #e0f2fe;
      font-weight: 600;
    }

    .upload-card input[type="file"] {
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 0.8rem;
      background: rgba(15,23,42,0.85);
      border: 1px dashed rgba(148,163,184,0.7);
      color: var(--text);
    }

    .file-hint {
      font-size: 0.75rem;
      color: #bfdbfe;
    }

    /* Tabs */
    .tabs {
      display: inline-flex;
      margin-top: 14px;
      border-radius: 999px;
      padding: 3px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(30,64,175,0.7);
    }

    .tab-btn {
      border: none;
      background: transparent;
      color: var(--muted);
      padding: 6px 16px;
      border-radius: 999px;
      font-size: 0.83rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.18s ease;
      white-space: nowrap;
    }

    .tab-btn span.icon {
      font-size: 0.9rem;
    }

    .tab-btn.active {
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      color: white;
      box-shadow: 0 0 0 1px rgba(15,23,42,0.7);
    }

    .tab-btn:not(.active):hover {
      background: rgba(30,64,175,0.55);
      color: #e5e7eb;
    }

    /* Layout */
    .grid {
      display: grid;
      grid-template-columns: minmax(0,2.1fr) minmax(0,1.3fr);
      gap: 14px;
      margin-top: 18px;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: minmax(0,1fr);
      }
    }

    .card {
      background: linear-gradient(145deg, var(--bg-card), #020617);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 14px 14px 12px;
      box-shadow: var(--shadow-soft);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 0.96rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-title .dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 10px rgba(56,189,248,0.9);
    }

    .card-subtitle {
      font-size: 0.78rem;
      color: var(--muted);
    }

    /* Summary badges */
    .summary-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 8px;
      margin-bottom: 10px;
    }

    .summary-pill {
      border-radius: var(--radius-sm);
      background: radial-gradient(circle at top left, rgba(56,189,248,0.2), rgba(15,23,42,0.95));
      border: 1px solid rgba(148,163,184,0.6);
      padding: 6px 8px;
    }

    .summary-label {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: #cbd5f5;
      margin-bottom: 4px;
    }

    .summary-value {
      font-size: 0.98rem;
      font-weight: 600;
    }

    .summary-hint {
      font-size: 0.72rem;
      color: var(--muted);
    }

    /* Filters */
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }

    .filter {
      display: flex;
      flex-direction: column;
      gap: 3px;
      min-width: 150px;
      flex: 1 1 150px;
    }

    .filter label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .filter select,
    .filter input[type="number"],
    .filter input[type="text"] {
      background: rgba(15,23,42,0.9);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 0.78rem;
    }

    .filter input[type="number"]::-webkit-outer-spin-button,
    .filter input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    /* Table */
    .table-wrapper {
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      overflow-y: auto;
      overflow-x: auto;
      max-height: 430px;
      max-width: 100%;
    }

    table {
      width: 100%;
      min-width: 650px;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    thead {
      background: linear-gradient(to right, rgba(15,23,42,0.95), rgba(30,64,175,0.7));
      position: sticky;
      top: 0;
      z-index: 1;
    }

    th, td {
      padding: 6px 8px;
      text-align: left;
      border-bottom: 1px solid rgba(31,41,55,0.9);
      white-space: nowrap;
    }

    th {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #cbd5f5;
      cursor: default;
      user-select: none;
    }

    th.sortable:hover {
      text-decoration: underline;
    }

    th .sort-indicator {
      font-size: 0.7rem;
      margin-left: 4px;
      opacity: 0.8;
    }

    tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.75);
    }

    tbody tr:hover {
      background: rgba(30,64,175,0.55);
    }

    .symbol-link {
      color: #e5e7eb;
      text-decoration: none;
    }

    .symbol-link:hover {
      color: #38bdf8;
      text-decoration: underline;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      padding: 1px 8px;
      font-size: 0.7rem;
    }

    .pill-green {
      background: rgba(16,185,129,0.16);
      color: #6ee7b7;
      border: 1px solid rgba(16,185,129,0.6);
    }
    .pill-yellow {
      background: rgba(234,179,8,0.18);
      color: #facc15;
      border: 1px solid rgba(234,179,8,0.6);
    }
    .pill-blue {
      background: rgba(59,130,246,0.2);
      color: #bfdbfe;
      border: 1px solid rgba(59,130,246,0.7);
    }
    .pill-red {
      background: rgba(248,113,113,0.18);
      color: #fecaca;
      border: 1px solid rgba(248,113,113,0.65);
    }

    .muted {
      color: var(--muted);
    }

    .side-card {
      margin-bottom: 10px;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    .chip {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      padding: 4px 11px;
      font-size: 0.74rem;
      cursor: pointer;
      background: radial-gradient(circle at top left, rgba(59,130,246,0.25), rgba(15,23,42,0.95));
      color: #e0f2fe;
      box-shadow: 0 8px 18px rgba(15,23,42,0.7);
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
    }

    .chip:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(15,23,42,0.9);
      background: radial-gradient(circle at top left, rgba(96,165,250,0.3), rgba(15,23,42,1));
    }

    .chip strong {
      color: #f9fafb;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .chip span.count {
      font-size: 0.7rem;
      color: rgba(191,219,254,0.95);
    }

    .help-box {
      font-size: 0.77rem;
      color: var(--muted);
      border-radius: var(--radius-sm);
      border: 1px dashed rgba(148,163,184,0.7);
      padding: 8px 10px;
      background: rgba(15,23,42,0.9);
    }

    .help-box ul {
      padding-left: 18px;
      margin: 6px 0 0;
    }

    .help-box li {
      margin-bottom: 2px;
    }

    .status-banner {
      margin-top: 10px;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .status-banner span {
      color: var(--accent);
      font-weight: 500;
    }

    /* Top stocks styling */
    .momentum-list {
      font-size: 0.74rem;
      color: var(--muted);
      list-style: none;
      padding-left: 0;
      margin: 4px 0 0;
    }

    .momentum-list li {
      margin-bottom: 4px;
    }

    .stock-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 9px;
      border-radius: 999px;
      background: rgba(15,23,42,0.85);
      border: 1px solid rgba(148,163,184,0.65);
      color: #e5e7eb;
      font-weight: 600;
      box-shadow: 0 8px 18px rgba(15,23,42,0.9);
    }

    .stock-chip::before {
      content: "";
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34,197,94,0.9);
    }

    /* Sector stocks list */
    .sector-stock-title {
      margin-top: 10px;
      font-size: 0.78rem;
      font-weight: 600;
      color: #e5e7eb;
    }

    .sector-stock-list {
      font-size: 0.74rem;
      list-style: none;
      padding-left: 0;
      margin: 4px 0 0;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .sector-stock-pill {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.7);
      color: #e5e7eb;
    }

    /* Sector momentum shift */
    .momentum-columns {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
      margin-top: 6px;
    }

    .momentum-list-title {
      font-size: 0.74rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #cbd5f5;
      margin-bottom: 4px;
      font-weight: 600;
    }

    .momentum-chip {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      font-size: 0.72rem;
      backdrop-filter: blur(10px);
    }

    .momentum-chip-gain {
      background: radial-gradient(circle at top left, rgba(22,163,74,0.45), rgba(15,23,42,0.95));
      border-color: rgba(34,197,94,0.7);
    }

    .momentum-chip-loss {
      background: radial-gradient(circle at top left, rgba(239,68,68,0.45), rgba(15,23,42,0.95));
      border-color: rgba(248,113,113,0.7);
    }

    .momentum-chip strong {
      color: #f9fafb;
    }

    .momentum-chip span.delta-pos {
      color: #bbf7d0;
    }

    .momentum-chip span.delta-neg {
      color: #fecaca;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="title-block">
        <h1>
          Momentum Dashboard
          <span class="tag-pill">Intraday Â· Swing Â· Positional</span>
        </h1>
        <p class="subtitle">
          Upload your JSON (converted from Screener CSV) and explore intraday (1h / 4h),
          swing (1â€“3 days), and positional (5â€“15 days) momentum in a single, clean dashboard.
        </p>
        <div class="tabs" id="modeTabs">
          <button class="tab-btn active" data-mode="intraday">
            <span class="icon">âš¡</span> Intraday (1h / 4h)
          </button>
          <button class="tab-btn" data-mode="swing">
            <span class="icon">ðŸ“ˆ</span> Swing (1â€“3 days)
          </button>
          <button class="tab-btn" data-mode="positional">
            <span class="icon">ðŸ§­</span> Positional (5â€“15 days)
          </button>
        </div>
      </div>
    </header>

    <div class="status-banner" id="statusBanner">
      Loading data from local file (data.json)...
    </div>

    <div class="grid">
      <!-- Main area -->
      <div>
        <div class="card" id="mainCard">
          <div class="card-header">
            <div>
              <div class="card-title">
                <span class="dot"></span>
                <span id="mainCardTitle">Intraday Momentum Radar (1h / 4h)</span>
              </div>
              <div class="card-subtitle" id="mainCardSubtitle">
                Stocks repeatedly triggered in the screener on intraday timeframes. Higher counts indicate stronger, more persistent intraday momentum.
              </div>
            </div>
          </div>

          <div class="summary-row" id="summaryRow">
            <!-- Summary cards injected by JS -->
          </div>

          <div class="filters" id="filtersRow">
            <!-- Filters injected by JS -->
          </div>

          <div class="table-wrapper">
            <table>
              <thead id="tableHead">
                <!-- Head injected by JS -->
              </thead>
              <tbody id="tableBody">
                <!-- Rows injected by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Side area -->
      <div>
        <div class="card side-card">
          <div class="card-header">
            <div class="card-title">
              <span class="dot"></span>
              <span id="sideTitle">Intraday Sector Highlight</span>
            </div>
          </div>
          <div id="sideContent">
            <div class="card-subtitle" id="sideSubtitle">
              Quick overview of where the current mode is seeing the most activity by sector and market cap.
            </div>
            <div style="margin-top:8px;">
              <div class="chip-row" id="chipRow">
                <!-- Chips injected -->
              </div>
            </div>
            <div style="margin-top:10px;">
              <div class="card-subtitle" id="topStocksSubtitle">
                <strong>Most active & Top 5 stocks</strong> for this timeframe.
              </div>
              <ul class="momentum-list" id="topStocksList">
                <!-- Top stocks injected -->
              </ul>
            </div>
            <div style="margin-top:10px;">
              <div class="sector-stock-title" id="sectorStocksTitle">
                Click a sector above to view its stocks.
              </div>
              <ul class="sector-stock-list" id="sectorStocksList">
                <!-- Stocks in selected sector -->
              </ul>
            </div>
          </div>
        </div>

        <div class="card side-card">
          <div class="card-header">
            <div class="card-title">
              <span class="dot"></span>
              <span id="momentumTitle">Sector Momentum Shift</span>
            </div>
          </div>
          <div id="momentumContent">
            <div class="card-subtitle" id="momentumSubtitle">
              <strong>Sector momentum shifts vs recent history.</strong>
            </div>
            <div class="momentum-columns">
              <div>
                <div class="momentum-list-title">Gaining momentum</div>
                <ul class="momentum-list" id="momentumGainers">
                  <!-- Gainers injected -->
                </ul>
              </div>
              <div>
                <div class="momentum-list-title">Losing momentum</div>
                <ul class="momentum-list" id="momentumLosers">
                  <!-- Losers injected -->
                </ul>
              </div>
            </div>
          </div>
        </div>

        <div class="help-box" id="helpBox">
          <strong>How to use this dashboard</strong>
          <ul id="helpList">
            <li>Upload your screener JSON to populate intraday, swing and positional views.</li>
            <li>Use the tabs above to switch between 1h/4h intraday, 1â€“3 day swing, and 5â€“15 day positional ideas.</li>
            <li>Filters help you focus by sector, market cap and minimum hits/days in trend.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ======== Utility functions ========
    function parseCustomDate(str) {
      if (!str) return null;
      const parts = str.split(" ");
      if (parts.length < 3) return null;
      const [datePart, timePart, ampmRaw] = parts;
      const [d, m, y] = datePart.split("-").map(Number);
      let [h, min] = timePart.split(":").map(Number);
      const ampm = ampmRaw.toLowerCase();
      if (ampm === "pm" && h !== 12) h += 12;
      if (ampm === "am" && h === 12) h = 0;
      return new Date(y, m - 1, d, h, min);
    }

    function formatDateOnly(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function getUnique(arr) {
      return Array.from(new Set(arr));
    }

    function groupBy(arr, keyFn) {
      const map = new Map();
      for (const item of arr) {
        const key = keyFn(item);
        if (!map.has(key)) map.set(key, []);
        map.get(key).push(item);
      }
      return map;
    }

    // ======== Global state ========
    const state = {
      raw: [],
      dates: [],
      mode: "intraday",
      aggregates: {
        intraday: [],
        swing: [],
        positional: []
      },
      filters: {
        sector: "all",
        marketcap: "all",
        min_hits: 0,
        min_swing_days: 0,
        min_days_in_trend: 0,
        lookback_intraday: "1h_4h",
        lookback_swing: "1_3d",
        lookback_positional: "7d",
        tag_search: "",
        swing_setup_search: "",
        positional_setup_search: ""
      },
      sort: {
        mode: "intraday",
        field: "total_hits",
        direction: "desc"
      }
    };

    const modeConfig = {
      intraday: {
        title: "Intraday Momentum Radar (1h / 4h)",
        subtitle: "Stocks repeatedly triggered in the screener on intraday timeframes. Higher counts indicate stronger, more persistent intraday momentum.",
        help: [
          "Start with the summary to see how many intraday symbols and which sector is most active.",
          "Use the table to shortlist names with strong 1h / 4h hits.",
          "Use sector and market cap filters to focus on your style (e.g., Smallcap intraday only)."
        ]
      },
      swing: {
        title: "Swing Momentum Picks (1â€“3 Days)",
        subtitle: "Consistently appearing stocks over the last 1â€“3 days. Higher day counts and ranks indicate stronger swing setups.",
        help: [
          "Start with swing candidates summary to see how many 1â€“3 day ideas are available.",
          "Focus on stocks with 2+ consecutive days to ride ongoing trends.",
          "Use sector filter to align swings with strong themes."
        ]
      },
      positional: {
        title: "Positional Strength Board (5â€“15 Days)",
        subtitle: "Stocks that consistently appear over 5â€“15 days. Ideal for multi-day or positional trend ideas.",
        help: [
          "Use this view to find leaders and themes that have stayed strong for several days.",
          "Pay attention to stocks with the highest 7d/15d hits.",
          "Use minimum days in trend filter to keep only strong candidates."
        ]
      }
    };

    // ======== Aggregation logic ========
    function preprocessRaw(json) {
      const rows = [];
      for (const r of json) {
        const dt = parseCustomDate(r.date);
        if (!dt) continue;
        const date_only = formatDateOnly(dt);
        const hour = dt.getHours();
        rows.push({
          ...r,
          _dt: dt,
          _dateOnly: date_only,
          _hour: hour,
          symbol: r.symbol,
          sector: r.sector,
          marketcapname: r.marketcapname
        });
      }
      rows.sort((a, b) => a._dt - b._dt);
      state.raw = rows;
      state.dates = getUnique(rows.map(r => r._dateOnly));
    }

    function aggregateIntraday() {
      const rows = state.raw;
      if (!rows.length) return [];
      const lastDate = state.dates[state.dates.length - 1];
      const subset = rows.filter(r => r._dateOnly === lastDate);
      const bySymbol = groupBy(subset, r => r.symbol);

      const result = [];
      for (const [symbol, list] of bySymbol.entries()) {
        const hours = getUnique(list.map(r => r._hour));
        const hits_1h = hours.length;
        const buckets = new Set();
        for (const h of hours) {
          const bucket = Math.floor((h - 9) / 4);
          buckets.add(bucket);
        }
        const hits_4h = buckets.size;
        const sample = list[0];
        result.push({
          symbol,
          sector: sample.sector,
          marketcapname: sample.marketcapname,
          hits_1h,
          hits_4h,
          total_hits: hits_1h + hits_4h
        });
      }
      return result.sort((a, b) => b.total_hits - a.total_hits);
    }

    function aggregateSwing(daysBack = 3) {
      const rows = state.raw;
      if (!rows.length) return [];
      const uniqueDates = state.dates;
      const lastDates = uniqueDates.slice(-daysBack);
      if (!lastDates.length) return [];

      const bySymbol = groupBy(
        rows.filter(r => lastDates.includes(r._dateOnly)),
        r => r.symbol
      );

      const last = lastDates[lastDates.length - 1];
      const result = [];

      for (const [symbol, list] of bySymbol.entries()) {
        const sample = list[0];
        const byDate = groupBy(list, r => r._dateOnly);
        const hits_1d = (byDate.get(last) || []).length;
        const lastTwo = lastDates.slice(-2);
        const hits_2d = lastTwo.reduce((acc, d) => acc + ((byDate.get(d) || []).length), 0);
        const hits_3d = lastDates.reduce((acc, d) => acc + ((byDate.get(d) || []).length), 0);

        let consec = 0;
        for (let i = lastDates.length - 1; i >= 0; i--) {
          const d = lastDates[i];
          const count = (byDate.get(d) || []).length;
          if (i === lastDates.length - 1 && count === 0) {
            consec = 0;
            break;
          }
          if (count > 0) {
            consec += 1;
          } else {
            break;
          }
        }

        result.push({
          symbol,
          sector: sample.sector,
          marketcapname: sample.marketcapname,
          hits_1d,
          hits_2d,
          hits_3d,
          consec_days: consec
        });
      }

      return result.sort((a, b) => b.hits_3d - a.hits_3d);
    }

    function aggregatePositional() {
      const rows = state.raw;
      if (!rows.length) return [];
      const uniqueDates = state.dates;
      if (!uniqueDates.length) return [];

      const last15 = uniqueDates.slice(-15);
      const bySymbol = groupBy(
        rows.filter(r => last15.includes(r._dateOnly)),
        r => r.symbol
      );

      const result = [];
      for (const [symbol, list] of bySymbol.entries()) {
        const sample = list[0];
        const byDate = groupBy(list, r => r._dateOnly);
        const hits_5dDates = last15.slice(-5);
        const hits_7dDates = last15.slice(-7);
        const hits_5d = hits_5dDates.reduce((acc, d) => acc + ((byDate.get(d) || []).length), 0);
        const hits_7d = hits_7dDates.reduce((acc, d) => acc + ((byDate.get(d) || []).length), 0);
        const hits_15d = last15.reduce((acc, d) => acc + ((byDate.get(d) || []).length), 0);

        const lastForTrend = last15.slice(-10);
        let daysInTrend = 0;
        for (const d of lastForTrend) {
          if ((byDate.get(d) || []).length > 0) daysInTrend++;
        }

        result.push({
          symbol,
          sector: sample.sector,
          marketcapname: sample.marketcapname,
          hits_5d,
          hits_7d,
          hits_15d,
          days_in_trend: daysInTrend
        });
      }

      return result.sort((a, b) => b.hits_15d - a.hits_15d);
    }

    function recomputeAggregates() {
      state.aggregates.intraday = aggregateIntraday();
      state.aggregates.swing = aggregateSwing(3);
      state.aggregates.positional = aggregatePositional();
    }

    // ======== Helpers for TAG / SETUP categories (used by filters + table) ========
    function getIntradayTagCategory(row) {
      const lb = state.filters.lookback_intraday;
      const total = lb === "1h"
        ? row.hits_1h
        : lb === "4h"
          ? row.hits_4h
          : (row.total_hits || (row.hits_1h + row.hits_4h));
      if (total >= 8) return "Very Active";
      if (total >= 5) return "Strong";
      if (total >= 3) return "On Radar";
      return "Watch";
    }

    function getSwingSetupCategory(row) {
      const c = row.consec_days || 0;
      if (c >= 3) return "Trend Continuation";
      if (c === 2) return "Building Momentum";
      if (c === 1 && row.hits_1d > 0) return "Fresh Breakout";
      return "On Watch";
    }

    function getPositionalSetupCategory(row) {
      const d = row.days_in_trend || 0;
      if (d >= 7) return "Trend Leader";
      if (d >= 5) return "Steady Climber";
      if (d >= 3) return "Emerging Theme";
      return "On Watch";
    }

    // ======== Sector momentum shift calculations ========
    function computeSectorMomentum(mode) {
      const gainers = [];
      const losers = [];

      if (!state.raw.length || !state.dates.length) {
        return { gainers, losers };
      }

      if (mode === "intraday") {
        const lastDate = state.dates[state.dates.length - 1];
        const subset = state.raw.filter(r => r._dateOnly === lastDate);
        const bySector = groupBy(subset, r => r.sector);
        for (const [sector, list] of bySector.entries()) {
          let morning = 0;
          let afternoon = 0;
          for (const r of list) {
            if (r._hour < 13) morning++;
            else afternoon++;
          }
          const delta = afternoon - morning;
          if (delta > 0) gainers.push({ sector, delta });
          if (delta < 0) losers.push({ sector, delta });
        }
      } else if (mode === "swing") {
        const dates = state.dates.slice(-3);
        if (dates.length < 2) return { gainers, losers };
        const last = dates[dates.length - 1];
        const prev = dates.slice(0, -1);
        const subset = state.raw.filter(r => dates.includes(r._dateOnly));
        const bySector = groupBy(subset, r => r.sector);
        for (const [sector, list] of bySector.entries()) {
          const byDate = groupBy(list, r => r._dateOnly);
          const lastCount = (byDate.get(last) || []).length;
          const prevTotal = prev.reduce((acc, d) => acc + ((byDate.get(d) || []).length), 0);
          const prevAvg = prev.length ? prevTotal / prev.length : 0;
          const delta = lastCount - prevAvg;
          if (delta > 0.1) gainers.push({ sector, delta });
          else if (delta < -0.1) losers.push({ sector, delta });
        }
      } else if (mode === "positional") {
        const dates = state.dates.slice(-15);
        if (dates.length < 6) return { gainers, losers };
        const last5 = dates.slice(-5);
        const prev = dates.slice(0, -5);
        const subset = state.raw.filter(r => dates.includes(r._dateOnly));
        const bySector = groupBy(subset, r => r.sector);
        for (const [sector, list] of bySector.entries()) {
          const byDate = groupBy(list, r => r._dateOnly);
          const lastTotal = last5.reduce((acc, d) => acc + ((byDate.get(d) || []).length), 0);
          const prevTotal = prev.reduce((acc, d) => acc + ((byDate.get(d) || []).length), 0);
          const prevAvg = prev.length ? prevTotal / prev.length : 0;
          const delta = lastTotal - prevAvg;
          if (delta > 0.1) gainers.push({ sector, delta });
          else if (delta < -0.1) losers.push({ sector, delta });
        }
      }

      gainers.sort((a, b) => b.delta - a.delta);
      losers.sort((a, b) => a.delta - b.delta);
      return {
        gainers: gainers.slice(0, 4),
        losers: losers.slice(0, 4)
      };
    }

    // ======== Rendering helpers ========
    function buildSummaryForMode(mode) {
      const row = document.getElementById("summaryRow");
      row.innerHTML = "";
      const agg = state.aggregates[mode] || [];
      if (!agg.length) return;

      const totalSymbols = agg.length;
      const bySector = groupBy(agg, a => a.sector);
      let topSector = null;
      let maxCount = -1;
      for (const [sector, list] of bySector.entries()) {
        if (list.length > maxCount) {
          maxCount = list.length;
          topSector = sector;
        }
      }

      const byMcap = groupBy(agg, a => a.marketcapname);
      let mcapSummary = [];
      for (const [mcap, list] of byMcap.entries()) {
        mcapSummary.push({ mcap, count: list.length });
      }
      mcapSummary.sort((a, b) => b.count - a.count);
      const dominant = mcapSummary[0];

      const createCard = (label, value, hint) => {
        const div = document.createElement("div");
        div.className = "summary-pill";
        div.innerHTML = `
          <div class="summary-label">${label}</div>
          <div class="summary-value">${value}</div>
          ${hint ? `<div class="summary-hint">${hint}</div>` : ""}
        `;
        return div;
      };

      if (mode === "intraday") {
        const total1h = agg.reduce((acc, a) => acc + a.hits_1h, 0);
        const total4h = agg.reduce((acc, a) => acc + a.hits_4h, 0);
        row.appendChild(createCard("Active intraday symbols", totalSymbols, "Unique stocks on the latest trading day."));
        row.appendChild(createCard("Total 1h hits", total1h, "Sum of hourly appearances across all symbols."));
        row.appendChild(createCard("Total 4h hits", total4h, "Approximate 4h block appearances."));
      } else if (mode === "swing") {
        const total3dHits = agg.reduce((acc, a) => acc + a.hits_3d, 0);
        const withConsec2 = agg.filter(a => a.consec_days >= 2).length;
        row.appendChild(createCard("Swing candidates (1â€“3d)", totalSymbols, "Unique stocks in last 3 trading days."));
        row.appendChild(createCard("3d hits (total)", total3dHits, "Sum of appearances over last 3 days."));
        row.appendChild(createCard("2+ consec days", withConsec2, "Stocks that fired on 2+ consecutive days."));
      } else if (mode === "positional") {
        const total15dHits = agg.reduce((acc, a) => acc + a.hits_15d, 0);
        const strongTrend = agg.filter(a => a.days_in_trend >= 5).length;
        row.appendChild(createCard("Positional candidates", totalSymbols, "Multi-day leaders in last 15 days."));
        row.appendChild(createCard("15d hits (total)", total15dHits, "Sum of appearances over last 15 days."));
        row.appendChild(createCard("5+ days in trend", strongTrend, "Stocks appearing on at least 5 days."));
      }

      if (topSector) {
        row.appendChild(
          createCard(
            "Most active sector",
            topSector,
            `${maxCount} symbols in this mode`
          )
        );
      }
      if (dominant) {
        row.appendChild(
          createCard(
            "Market cap bias",
            dominant.mcap || "Mixed",
            `${dominant.count} symbols in this bucket`
          )
        );
      }
    }

    function buildFiltersForMode(mode) {
      const container = document.getElementById("filtersRow");
      container.innerHTML = "";
      const agg = state.aggregates[mode] || [];
      if (!agg.length) return;

      const sectors = getUnique(agg.map(a => a.sector)).sort();
      const mcaps = getUnique(agg.map(a => a.marketcapname)).sort();

      function createFilter(id, labelText, inputEl) {
        const wrap = document.createElement("div");
        wrap.className = "filter";
        const label = document.createElement("label");
        label.htmlFor = id;
        label.textContent = labelText;
        inputEl.id = id;
        wrap.appendChild(label);
        wrap.appendChild(inputEl);
        return wrap;
      }

      // Sector
      const sectorSelect = document.createElement("select");
      sectorSelect.innerHTML = `<option value="all">All</option>` + sectors.map(s => `<option value="${s}">${s}</option>`).join("");
      sectorSelect.value = state.filters.sector || "all";
      sectorSelect.addEventListener("change", () => {
        state.filters.sector = sectorSelect.value;
        renderTableForMode(mode);
        renderSideForMode(mode);
      });
      container.appendChild(createFilter("filterSector", "Sector", sectorSelect));

      // Market cap
      const mcapSelect = document.createElement("select");
      mcapSelect.innerHTML = `<option value="all">All</option>` + mcaps.map(s => `<option value="${s}">${s}</option>`).join("");
      mcapSelect.value = state.filters.marketcap || "all";
      mcapSelect.addEventListener("change", () => {
        state.filters.marketcap = mcapSelect.value;
        renderTableForMode(mode);
        renderSideForMode(mode);
      });
      container.appendChild(createFilter("filterMcap", "Market Cap", mcapSelect));

      // Mode-specific filters
      if (mode === "intraday") {
        const lbSelect = document.createElement("select");
        lbSelect.innerHTML = `
          <option value="1h_4h">1h + 4h (combined)</option>
          <option value="1h">1h only</option>
          <option value="4h">4h only</option>
        `;
        lbSelect.value = state.filters.lookback_intraday || "1h_4h";
        lbSelect.addEventListener("change", () => {
          state.filters.lookback_intraday = lbSelect.value;
          renderTableForMode(mode);
          renderSideForMode(mode);
        });
        container.appendChild(createFilter("filterLookbackIntraday", "Lookback", lbSelect));

        const minHits = document.createElement("input");
        minHits.type = "number";
        minHits.min = "0";
        minHits.value = state.filters.min_hits || 0;
        minHits.addEventListener("input", () => {
          state.filters.min_hits = parseInt(minHits.value || "0", 10);
          renderTableForMode(mode);
          renderSideForMode(mode);
        });
        container.appendChild(createFilter("filterMinHits", "Min. intraday hits", minHits));

        // TAG search (Intraday)
        const tagSearch = document.createElement("input");
        tagSearch.type = "text";
        tagSearch.placeholder = "Very Active / Strong / Watch";
        tagSearch.value = state.filters.tag_search || "";
        tagSearch.addEventListener("input", () => {
          state.filters.tag_search = tagSearch.value.trim().toLowerCase();
          renderTableForMode(mode);
          renderSideForMode(mode);
        });
        container.appendChild(createFilter("filterTagSearch", "Tag search", tagSearch));

      } else if (mode === "swing") {
        const minDays = document.createElement("input");
        minDays.type = "number";
        minDays.min = "0";
        minDays.value = state.filters.min_swing_days || 0;
        minDays.addEventListener("input", () => {
          state.filters.min_swing_days = parseInt(minDays.value || "0", 10);
          renderTableForMode(mode);
          renderSideForMode(mode);
        });
        container.appendChild(createFilter("filterMinSwingDays", "Min. consec days", minDays));

        // SETUP search (Swing)
        const setupSearch = document.createElement("input");
        setupSearch.type = "text";
        setupSearch.placeholder = "Trend Continuation / Fresh Breakout";
        setupSearch.value = state.filters.swing_setup_search || "";
        setupSearch.addEventListener("input", () => {
          state.filters.swing_setup_search = setupSearch.value.trim().toLowerCase();
          renderTableForMode(mode);
          renderSideForMode(mode);
        });
        container.appendChild(createFilter("filterSwingSetupSearch", "Setup search", setupSearch));

      } else if (mode === "positional") {
        const minDays = document.createElement("input");
        minDays.type = "number";
        minDays.min = "0";
        minDays.value = state.filters.min_days_in_trend || 0;
        minDays.addEventListener("input", () => {
          state.filters.min_days_in_trend = parseInt(minDays.value || "0", 10);
          renderTableForMode(mode);
          renderSideForMode(mode);
        });
        container.appendChild(createFilter("filterMinTrendDays", "Min. days in trend", minDays));

        // SETUP search (Positional)
        const setupSearchPos = document.createElement("input");
        setupSearchPos.type = "text";
        setupSearchPos.placeholder = "Trend Leader / Steady Climber";
        setupSearchPos.value = state.filters.positional_setup_search || "";
        setupSearchPos.addEventListener("input", () => {
          state.filters.positional_setup_search = setupSearchPos.value.trim().toLowerCase();
          renderTableForMode(mode);
          renderSideForMode(mode);
        });
        container.appendChild(createFilter("filterPositionalSetupSearch", "Setup search", setupSearchPos));
      }
    }

    function filteredAggregates(mode) {
      const agg = state.aggregates[mode] || [];
      const {
        sector,
        marketcap,
        min_hits,
        min_swing_days,
        min_days_in_trend,
        lookback_intraday,
        tag_search,
        swing_setup_search,
        positional_setup_search
      } = state.filters;

      return agg.filter(row => {
        if (sector !== "all" && row.sector !== sector) return false;
        if (marketcap !== "all" && row.marketcapname !== marketcap) return false;

        if (mode === "intraday") {
          const total = row.total_hits || (row.hits_1h + row.hits_4h);
          if (min_hits > 0 && total < min_hits) return false;
          if (lookback_intraday === "1h" && row.hits_1h === 0) return false;
          if (lookback_intraday === "4h" && row.hits_4h === 0) return false;

          if (tag_search) {
            const cat = getIntradayTagCategory(row).toLowerCase();
            if (!cat.includes(tag_search)) return false;
          }
        }

        if (mode === "swing") {
          if (min_swing_days > 0 && (row.consec_days || 0) < min_swing_days) return false;
          if (swing_setup_search) {
            const cat = getSwingSetupCategory(row).toLowerCase();
            if (!cat.includes(swing_setup_search)) return false;
          }
        }

        if (mode === "positional") {
          if (min_days_in_trend > 0 && (row.days_in_trend || 0) < min_days_in_trend) return false;
          if (positional_setup_search) {
            const cat = getPositionalSetupCategory(row).toLowerCase();
            if (!cat.includes(positional_setup_search)) return false;
          }
        }
        return true;
      });
    }

    function applySorting(rows, mode) {
      const sort = state.sort;
      if (sort.mode !== mode || !sort.field) return rows;

      const dir = sort.direction === "asc" ? 1 : -1;

      const sorted = [...rows].sort((a, b) => {
        const field = sort.field;
        let va, vb;

        if (mode === "intraday") {
          if (field === "symbol" || field === "sector" || field === "marketcapname") {
            va = (a[field] || "").toString().toUpperCase();
            vb = (b[field] || "").toString().toUpperCase();
            if (va < vb) return -1 * dir;
            if (va > vb) return 1 * dir;
            return 0;
          }
          if (field === "hits_1h" || field === "hits_4h" || field === "total_hits") {
            va = a[field] != null ? a[field] : 0;
            vb = b[field] != null ? b[field] : 0;
            return (va - vb) * dir;
          }
          if (field === "tag_priority") {
            const getPriority = (row) => {
              const total = row.total_hits || (row.hits_1h + row.hits_4h);
              if (total >= 8) return 3;
              if (total >= 5) return 2;
              if (total >= 3) return 1;
              return 0;
            };
            va = getPriority(a);
            vb = getPriority(b);
            return (va - vb) * dir;
          }
        }

        return 0;
      });

      return sorted;
    }

    function renderTableForMode(mode) {
      const thead = document.getElementById("tableHead");
      const tbody = document.getElementById("tableBody");
      thead.innerHTML = "";
      tbody.innerHTML = "";

      let rows = filteredAggregates(mode);
      if (!rows.length) {
        thead.innerHTML = "<tr><th>No data</th></tr>";
        tbody.innerHTML = "<tr><td class='muted'>No rows to display. Adjust filters or upload JSON.</td></tr>";
        return;
      }

      if (mode === "intraday") {
        rows = applySorting(rows, mode);
      }

      let headersConfig = [];
      if (mode === "intraday") {
        headersConfig = [
          { label: "Symbol", field: "symbol" },
          { label: "Sector", field: "sector" },
          { label: "MCap", field: "marketcapname" },
          { label: "1h Hits", field: "hits_1h" },
          { label: "4h Hits", field: "hits_4h" },
          { label: "Total Hits", field: "total_hits" },
          { label: "Tag", field: "tag_priority" }
        ];
      } else if (mode === "swing") {
        headersConfig = [
          { label: "Symbol" },
          { label: "Sector" },
          { label: "MCap" },
          { label: "1d Hits" },
          { label: "2d Hits" },
          { label: "3d Hits" },
          { label: "Consec Days" },
          { label: "Setup" }
        ];
      } else if (mode === "positional") {
        headersConfig = [
          { label: "Symbol" },
          { label: "Sector" },
          { label: "MCap" },
          { label: "5d Hits" },
          { label: "7d Hits" },
          { label: "15d Hits" },
          { label: "Days in Trend" },
          { label: "Setup" }
        ];
      }

      const tr = document.createElement("tr");
      headersConfig.forEach((h) => {
        const th = document.createElement("th");
        th.textContent = h.label;
        if (mode === "intraday" && h.field) {
          th.classList.add("sortable");
          th.dataset.field = h.field;
          if (state.sort.mode === mode && state.sort.field === h.field) {
            const span = document.createElement("span");
            span.className = "sort-indicator";
            span.textContent = state.sort.direction === "asc" ? "â–²" : "â–¼";
            th.appendChild(span);
          }
          th.addEventListener("click", () => {
            if (state.sort.mode === mode && state.sort.field === h.field) {
              state.sort.direction = state.sort.direction === "asc" ? "desc" : "asc";
            } else {
              state.sort.mode = mode;
              state.sort.field = h.field;
              state.sort.direction = "asc";
            }
            renderTableForMode(mode);
          });
        }
        tr.appendChild(th);
      });
      thead.appendChild(tr);

      const getIntradayTag = (row) => {
        const category = getIntradayTagCategory(row);
        if (category === "Very Active") return `<span class="pill pill-green">ðŸ”¥ ${category}</span>`;
        if (category === "Strong") return `<span class="pill pill-blue">âš¡ ${category}</span>`;
        if (category === "On Radar") return `<span class="pill pill-yellow">ðŸ‘€ ${category}</span>`;
        return `<span class="pill pill-yellow">${category}</span>`;
      };

      const getSwingSetup = (row) => {
        const category = getSwingSetupCategory(row);
        if (category === "Trend Continuation") return `<span class="pill pill-green">${category}</span>`;
        if (category === "Building Momentum") return `<span class="pill pill-blue">${category}</span>`;
        if (category === "Fresh Breakout") return `<span class="pill pill-yellow">${category}</span>`;
        return `<span class="pill pill-yellow">${category}</span>`;
      };

      const getPositionalSetup = (row) => {
        const category = getPositionalSetupCategory(row);
        if (category === "Trend Leader") return `<span class="pill pill-green">${category}</span>`;
        if (category === "Steady Climber") return `<span class="pill pill-blue">${category}</span>`;
        if (category === "Emerging Theme") return `<span class="pill pill-yellow">${category}</span>`;
        return `<span class="pill pill-yellow">${category}</span>`;
      };

      const lbIntraday = state.filters.lookback_intraday;

      const rowsHtml = rows.map(row => {
        if (mode === "intraday") {
          const total = lbIntraday === "1h"
            ? row.hits_1h
            : lbIntraday === "4h"
              ? row.hits_4h
              : (row.total_hits || (row.hits_1h + row.hits_4h));
          const tvUrl = `https://in.tradingview.com/chart/?symbol=${encodeURIComponent(row.symbol)}`;
          return `<tr>
            <td><a href="${tvUrl}" target="_blank" rel="noreferrer" class="symbol-link">${row.symbol}</a></td>
            <td>${row.sector}</td>
            <td>${row.marketcapname}</td>
            <td>${row.hits_1h}</td>
            <td>${row.hits_4h}</td>
            <td>${total}</td>
            <td>${getIntradayTag(row)}</td>
          </tr>`;
        } else if (mode === "swing") {
          const tvUrl = `https://in.tradingview.com/chart/?symbol=${encodeURIComponent(row.symbol)}`;
          return `<tr>
            <td><a href="${tvUrl}" target="_blank" rel="noreferrer" class="symbol-link">${row.symbol}</a></td>
            <td>${row.sector}</td>
            <td>${row.marketcapname}</td>
            <td>${row.hits_1d}</td>
            <td>${row.hits_2d}</td>
            <td>${row.hits_3d}</td>
            <td>${row.consec_days}</td>
            <td>${getSwingSetup(row)}</td>
          </tr>`;
        } else {
          const tvUrl = `https://in.tradingview.com/chart/?symbol=${encodeURIComponent(row.symbol)}`;
          return `<tr>
            <td><a href="${tvUrl}" target="_blank" rel="noreferrer" class="symbol-link">${row.symbol}</a></td>
            <td>${row.sector}</td>
            <td>${row.marketcapname}</td>
            <td>${row.hits_5d}</td>
            <td>${row.hits_7d}</td>
            <td>${row.hits_15d}</td>
            <td>${row.days_in_trend}</td>
            <td>${getPositionalSetup(row)}</td>
          </tr>`;
        }
      }).join("");

      tbody.innerHTML = rowsHtml;
    }

    function renderTopStocksForMode(mode) {
      const listEl = document.getElementById("topStocksList");
      const subtitleEl = document.getElementById("topStocksSubtitle");
      listEl.innerHTML = "";
      const rows = filteredAggregates(mode);
      if (!rows.length) {
        subtitleEl.innerHTML = "<strong>Most active & Top 5 stocks</strong> will appear here once data is loaded.";
        return;
      }

      if (mode === "intraday") {
        subtitleEl.innerHTML = "<strong>Most active by 1h / 4h</strong> and <strong>Top 5 combined intraday hits</strong>.";
        let most1h = [...rows].sort((a, b) => b.hits_1h - a.hits_1h)[0];
        let most4h = [...rows].sort((a, b) => b.hits_4h - a.hits_4h)[0];
        const lb = state.filters.lookback_intraday;
        const getTotal = r => lb === "1h" ? r.hits_1h : lb === "4h" ? r.hits_4h : (r.total_hits || (r.hits_1h + r.hits_4h));
        const top5 = [...rows].sort((a, b) => getTotal(b) - getTotal(a)).slice(0, 5);

        if (most1h) {
          listEl.innerHTML += `<li><strong>Most active (1h):</strong> <span class="stock-chip">${most1h.symbol}</span> â€“ ${most1h.hits_1h} hits</li>`;
        }
        if (most4h) {
          listEl.innerHTML += `<li><strong>Most active (4h):</strong> <span class="stock-chip">${most4h.symbol}</span> â€“ ${most4h.hits_4h} blocks</li>`;
        }
        listEl.innerHTML += `<li><strong>Top 5 (combined):</strong> ${top5.map(r => `<span class="stock-chip">${r.symbol}</span>`).join(" ")}</li>`;
      } else if (mode === "swing") {
        subtitleEl.innerHTML = "<strong>Most active for 1d / 2d / 3d</strong> and <strong>Top 5 by 3d hits</strong>.";
        const most1d = [...rows].sort((a, b) => b.hits_1d - a.hits_1d)[0];
        const most2d = [...rows].sort((a, b) => b.hits_2d - a.hits_2d)[0];
        const most3d = [...rows].sort((a, b) => b.hits_3d - a.hits_3d)[0];
        const top5 = [...rows].sort((a, b) => b.hits_3d - a.hits_3d).slice(0, 5);

        if (most1d) listEl.innerHTML += `<li><strong>Most active (1d):</strong> <span class="stock-chip">${most1d.symbol}</span> â€“ ${most1d.hits_1d} hits</li>`;
        if (most2d) listEl.innerHTML += `<li><strong>Most active (2d):</strong> <span class="stock-chip">${most2d.symbol}</span> â€“ ${most2d.hits_2d} hits</li>`;
        if (most3d) listEl.innerHTML += `<li><strong>Most active (3d):</strong> <span class="stock-chip">${most3d.symbol}</span> â€“ ${most3d.hits_3d} hits</li>`;
        listEl.innerHTML += `<li><strong>Top 5 (3d hits):</strong> ${top5.map(r => `<span class="stock-chip">${r.symbol}</span>`).join(" ")}</li>`;
      } else {
        subtitleEl.innerHTML = "<strong>Most active for 5d / 7d / 15d</strong> and <strong>Top 5 by 15d hits</strong>.";
        const most5d = [...rows].sort((a, b) => b.hits_5d - a.hits_5d)[0];
        const most7d = [...rows].sort((a, b) => b.hits_7d - a.hits_7d)[0];
        const most15d = [...rows].sort((a, b) => b.hits_15d - a.hits_15d)[0];
        const top5 = [...rows].sort((a, b) => b.hits_15d - a.hits_15d).slice(0, 5);

        if (most5d) listEl.innerHTML += `<li><strong>Most active (5d):</strong> <span class="stock-chip">${most5d.symbol}</span> â€“ ${most5d.hits_5d} hits</li>`;
        if (most7d) listEl.innerHTML += `<li><strong>Most active (7d):</strong> <span class="stock-chip">${most7d.symbol}</span> â€“ ${most7d.hits_7d} hits</li>`;
        if (most15d) listEl.innerHTML += `<li><strong>Most active (15d):</strong> <span class="stock-chip">${most15d.symbol}</span> â€“ ${most15d.hits_15d} hits</li>`;
        listEl.innerHTML += `<li><strong>Top 5 (15d hits):</strong> ${top5.map(r => `<span class="stock-chip">${r.symbol}</span>`).join(" ")}</li>`;
      }
    }

    function renderSectorStocksForMode(mode, sectorName) {
      const titleEl = document.getElementById("sectorStocksTitle");
      const listEl = document.getElementById("sectorStocksList");
      listEl.innerHTML = "";
      if (!sectorName) {
        titleEl.textContent = "Click a sector above to view its stocks.";
        return;
      }

      const rows = filteredAggregates(mode).filter(r => r.sector === sectorName);
      if (!rows.length) {
        titleEl.textContent = `No stocks for sector ${sectorName} with current filters.`;
        return;
      }

      titleEl.textContent = `Stocks in ${sectorName}`;
      let sorted = [...rows];
      if (mode === "intraday") {
        const lb = state.filters.lookback_intraday;
        const getTotal = r => lb === "1h" ? r.hits_1h : lb === "4h" ? r.hits_4h : (r.total_hits || (r.hits_1h + r.hits_4h));
        sorted.sort((a, b) => getTotal(b) - getTotal(a));
      } else if (mode === "swing") {
        sorted.sort((a, b) => b.hits_3d - a.hits_3d);
      } else {
        sorted.sort((a, b) => b.hits_15d - a.hits_15d);
      }

      const seen = new Set();
      sorted.forEach(r => {
        if (seen.has(r.symbol)) return;
        seen.add(r.symbol);
        const li = document.createElement("li");
        li.className = "sector-stock-pill";
        li.textContent = r.symbol;
        listEl.appendChild(li);
      });
    }

    function renderSideForMode(mode) {
      const chipRow = document.getElementById("chipRow");
      const sideTitle = document.getElementById("sideTitle");
      const sideSubtitle = document.getElementById("sideSubtitle");
      chipRow.innerHTML = "";
      const rows = filteredAggregates(mode);

      if (!rows.length) {
        sideTitle.textContent = "No data for this view";
        sideSubtitle.textContent = "Upload JSON or relax filters to see sector and market cap highlights.";
        document.getElementById("topStocksList").innerHTML = "";
        document.getElementById("sectorStocksTitle").textContent = "Click a sector above to view its stocks.";
        document.getElementById("sectorStocksList").innerHTML = "";
        document.getElementById("momentumGainers").innerHTML = "";
        document.getElementById("momentumLosers").innerHTML = "";
        document.getElementById("momentumSubtitle").innerHTML = "<strong>Sector momentum shifts vs recent history.</strong>";
        return;
      }

      if (mode === "intraday") {
        sideTitle.textContent = "Intraday Sector Highlight";
        sideSubtitle.textContent = "Sectors with the most hourly and 4h intraday hits on the latest trading day.";
      } else if (mode === "swing") {
        sideTitle.textContent = "Swing Sector Board (1â€“3 Days)";
        sideSubtitle.textContent = "Sectors with the highest count of 1â€“3 day swing candidates.";
      } else {
        sideTitle.textContent = "Positional Sector Heat (5â€“15 Days)";
        sideSubtitle.textContent = "Sectors with the strongest multi-day presence in the screener.";
      }

      const bySector = groupBy(rows, r => r.sector);
      const sectorArr = [];
      for (const [sector, list] of bySector.entries()) {
        sectorArr.push({ sector, count: list.length });
      }
      sectorArr.sort((a, b) => b.count - a.count);

      const byMcap = groupBy(rows, r => r.marketcapname);
      const mcapArr = [];
      for (const [mcap, list] of byMcap.entries()) {
        mcapArr.push({ mcap, count: list.length });
      }
      mcapArr.sort((a, b) => b.count - a.count);

      const topSectors = sectorArr.slice(0, 4);
      const topMcaps = mcapArr.slice(0, 3);

      let defaultSector = null;
      topSectors.forEach((s, idx) => {
        const div = document.createElement("div");
        div.className = "chip";
        div.dataset.sector = s.sector;
        div.innerHTML = `<strong>${s.sector}</strong> <span class="count">Â· ${s.count} stk</span>`;
        div.addEventListener("click", () => {
          renderSectorStocksForMode(mode, s.sector);
        });
        chipRow.appendChild(div);
        if (idx === 0) defaultSector = s.sector;
      });
      topMcaps.forEach((m) => {
        const div = document.createElement("div");
        div.className = "chip";
        div.innerHTML = `<strong>${m.mcap}</strong> <span class="count">Â· ${m.count} stk</span>`;
        chipRow.appendChild(div);
      });

      // Default sector stocks
      renderSectorStocksForMode(mode, defaultSector);

      // Top stocks box
      renderTopStocksForMode(mode);

      // Sector momentum shift box
      const { gainers, losers } = computeSectorMomentum(mode);
      const gainersEl = document.getElementById("momentumGainers");
      const losersEl = document.getElementById("momentumLosers");
      const subtitle = document.getElementById("momentumSubtitle");
      gainersEl.innerHTML = "";
      losersEl.innerHTML = "";

      if (!gainers.length && !losers.length) {
        subtitle.innerHTML = "<strong>Not enough history to compute sector momentum shifts for this mode.</strong>";
      } else {
        subtitle.innerHTML = "<strong>Sectors gaining or losing momentum vs their recent baseline.</strong>";
      }

      gainers.forEach(g => {
        const li = document.createElement("li");
        li.innerHTML = `<div class="momentum-chip momentum-chip-gain"><strong>${g.sector}</strong><span class="delta-pos">+${g.delta.toFixed(1)}</span></div>`;
        gainersEl.appendChild(li);
      });
      losers.forEach(l => {
        const li = document.createElement("li");
        li.innerHTML = `<div class="momentum-chip momentum-chip-loss"><strong>${l.sector}</strong><span class="delta-neg">${l.delta.toFixed(1)}</span></div>`;
        losersEl.appendChild(li);
      });
    }

    function renderHelpForMode(mode) {
      const helpList = document.getElementById("helpList");
      helpList.innerHTML = "";
      const cfg = modeConfig[mode];
      if (!cfg) return;
      cfg.help.forEach(text => {
        const li = document.createElement("li");
        li.textContent = text;
        helpList.appendChild(li);
      });
    }

    function renderMode() {
      const mode = state.mode;
      const cfg = modeConfig[mode];
      document.getElementById("mainCardTitle").textContent = cfg.title;
      document.getElementById("mainCardSubtitle").textContent = cfg.subtitle;

      buildSummaryForMode(mode);
      buildFiltersForMode(mode);
      renderTableForMode(mode);
      renderSideForMode(mode);
      renderHelpForMode(mode);
    }

    // ======== Auto-load data.json & Event wiring ========

    async function loadPrebuiltData() {
      const statusEl = document.getElementById("statusBanner");
      if (!statusEl) return;
      try {
        statusEl.textContent = "Loading data from data.json...";
        const res = await fetch("data.json", { cache: "no-cache" });
        if (!res.ok) {
          throw new Error("Failed to fetch data.json, HTTP " + res.status);
        }
        const json = await res.json();
        preprocessRaw(json);
        recomputeAggregates();
        statusEl.innerHTML =
          `Loaded <span>${state.raw.length}</span> rows across <span>${state.dates.length}</span> trading days.`;
        renderMode();
      } catch (err) {
        console.error("Auto-load failed:", err);
        statusEl.textContent = "Auto-load failed. Please ensure data.json exists next to this HTML file.";
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      loadPrebuiltData();

      document.querySelectorAll("#modeTabs .tab-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const mode = btn.dataset.mode;
          if (!mode || state.mode === mode) return;
          state.mode = mode;
          document.querySelectorAll("#modeTabs .tab-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          renderMode();
        });
      });
    });

  </script>
</body>
</html>
