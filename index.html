<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Enhanced Momentum Dashboard - Trading Signals</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b1020;
      --bg-card: #111729;
      --accent: #38bdf8;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #f97373;
      --success: #22c55e;
      --warning: #facc15;
      --border: #1f2937;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 55%);
      color: var(--text);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      font-size: 2rem;
      margin-bottom: 10px;
      background: linear-gradient(135deg, var(--accent), var(--success));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .subtitle {
      text-align: center;
      color: var(--muted);
      margin-bottom: 20px;
      font-size: 0.9rem;
    }

    /* Market Cap Filter Buttons */
    .mcap-filters {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .mcap-btn {
      padding: 10px 20px;
      border-radius: 25px;
      border: 2px solid var(--border);
      background: rgba(15,23,42,0.9);
      color: var(--muted);
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      font-size: 0.9rem;
    }

    .mcap-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      transform: translateY(-2px);
    }

    .mcap-btn.active {
      background: linear-gradient(135deg, var(--accent), #6366f1);
      border-color: var(--accent);
      color: white;
      box-shadow: 0 4px 15px rgba(56,189,248,0.4);
    }

    /* Tabs */
    .tabs {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .tab-btn {
      padding: 10px 24px;
      border-radius: 25px;
      border: none;
      background: rgba(15,23,42,0.9);
      color: var(--muted);
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .tab-btn.active {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
    }

    /* Card */
    .card {
      background: linear-gradient(145deg, var(--bg-card), #020617);
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .card-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--accent);
    }

    /* Status Banner */
    .status-banner {
      padding: 12px 20px;
      background: rgba(15,23,42,0.8);
      border-radius: 8px;
      border-left: 3px solid var(--accent);
      margin-bottom: 20px;
      font-size: 0.9rem;
    }

    .status-banner span.highlight {
      color: var(--accent);
      font-weight: 600;
    }

    /* Summary Stats */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-box {
      background: rgba(15,23,42,0.9);
      padding: 15px;
      border-radius: 8px;
      border: 1px solid var(--border);
      text-align: center;
    }

    .stat-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--accent);
    }

    /* Table */
    .table-wrapper {
      overflow-x: auto;
      overflow-y: auto;
      max-height: 700px;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    table {
      width: 100%;
      min-width: 1200px;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    thead {
      background: linear-gradient(to right, rgba(15,23,42,0.95), rgba(30,64,175,0.7));
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th {
      padding: 12px 10px;
      text-align: left;
      font-size: 0.75rem;
      text-transform: uppercase;
      color: #cbd5f5;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }

    th:hover {
      background: rgba(30,64,175,0.4);
    }

    td {
      padding: 12px 10px;
      border-bottom: 1px solid rgba(31,41,55,0.9);
      white-space: nowrap;
    }

    tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.75);
    }

    tbody tr:hover {
      background: rgba(30,64,175,0.55);
    }

    .symbol-link {
      color: #e5e7eb;
      text-decoration: none;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .symbol-link:hover {
      color: var(--accent);
      text-decoration: underline;
    }

    .price-cell { color: var(--accent); font-weight: 700; }
    .sl-cell { color: var(--danger); font-weight: 600; }
    .target-cell { color: var(--success); font-weight: 600; }

    .pill {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    .pill-green { background: rgba(16,185,129,0.16); color: #6ee7b7; border: 1px solid rgba(16,185,129,0.6); }
    .pill-yellow { background: rgba(234,179,8,0.18); color: #facc15; border: 1px solid rgba(234,179,8,0.6); }
    .pill-red { background: rgba(248,113,113,0.18); color: #fecaca; border: 1px solid rgba(248,113,113,0.65); }

    /* Help Box */
    .help-box {
      background: rgba(15,23,42,0.9);
      border: 1px dashed var(--border);
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .help-box strong {
      color: var(--text);
    }

    .help-box ul {
      margin: 10px 0 0 20px;
    }

    .help-box li {
      margin-bottom: 5px;
    }

    @media (max-width: 768px) {
      h1 { font-size: 1.5rem; }
      .mcap-filters, .tabs { gap: 5px; }
      .mcap-btn, .tab-btn { padding: 8px 16px; font-size: 0.8rem; }
      table { min-width: 900px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>‚ö° Enhanced Momentum Dashboard</h1>
    <p class="subtitle">Complete Trading Signals with Entry, Stop Loss & Target Levels</p>

    <!-- Market Cap Quick Filters -->
    <div class="mcap-filters">
      <button class="mcap-btn active" onclick="filterByMcap('all')">üåü All Market Caps</button>
      <button class="mcap-btn" onclick="filterByMcap('Largecap')">üè¢ Large Cap</button>
      <button class="mcap-btn" onclick="filterByMcap('Midcap')">üè≠ Mid Cap</button>
      <button class="mcap-btn" onclick="filterByMcap('Smallcap')">üöÄ Small Cap</button>
    </div>

    <!-- Strategy Tabs -->
    <div class="tabs">
      <button class="tab-btn active" onclick="switchMode('intraday')">‚ö° Intraday (1h/4h)</button>
      <button class="tab-btn" onclick="switchMode('swing')">üìà Swing (1-3 days)</button>
      <button class="tab-btn" onclick="switchMode('positional')">üß≠ Positional (5-15 days)</button>
    </div>

    <!-- Status Banner -->
    <div class="status-banner" id="statusBanner">
      <span>‚óè</span> Loading data from cloud...
    </div>

    <!-- Summary Stats -->
    <div class="summary-grid" id="summaryGrid">
      <!-- Stats injected by JS -->
    </div>

    <!-- Main Data Card -->
    <div class="card">
      <div class="card-title" id="cardTitle">Intraday Trading Signals</div>
      
      <div class="table-wrapper">
        <table>
          <thead id="tableHead">
            <tr>
              <th onclick="sortBy('symbol')">Symbol</th>
              <th onclick="sortBy('sector')">Sector</th>
              <th onclick="sortBy('marketcapname')">Market Cap</th>
              <th onclick="sortBy('price')">Entry ‚Çπ</th>
              <th>Stop Loss ‚Çπ</th>
              <th>Target ‚Çπ</th>
              <th>R:R</th>
              <th onclick="sortBy('hits')">Signals</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr><td colspan="8" style="text-align:center;padding:40px;color:#9ca3af;">Loading signals...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Help Box -->
    <div class="help-box">
      <strong>üìä How to Use This Dashboard</strong>
      <ul>
        <li><strong style="color:#38bdf8">Entry:</strong> Current market price - your buy level</li>
        <li><strong style="color:#f97373">Stop Loss:</strong> Exit point to limit losses (2-5% below entry)</li>
        <li><strong style="color:#22c55e">Target:</strong> Profit booking level based on risk-reward ratio</li>
        <li><strong>R:R Ratio:</strong> Risk-Reward (Good: 2+, Medium: 1.5-2, Poor: <1.5)</li>
        <li><strong>Market Cap Filters:</strong> Click buttons above to filter by company size</li>
        <li><strong>Strategy Tabs:</strong> Intraday (quick trades), Swing (2-5 days), Positional (weeks)</li>
        <li><strong>Click Symbol:</strong> Opens TradingView chart in new tab</li>
      </ul>
    </div>
  </div>

  <script>
    // ========================================
    // GLOBAL STATE
    // ========================================
    const state = {
      raw: [],
      dates: [],
      mode: 'intraday',
      selectedMcap: 'all',
      aggregates: {
        intraday: [],
        swing: [],
        positional: []
      },
      sortField: null,
      sortDirection: 'desc'
    };

    // ========================================
    // UTILITY FUNCTIONS
    // ========================================
    function parseCustomDate(str) {
      if (!str) return null;
      const parts = str.split(" ");
      if (parts.length < 3) return null;
      const [datePart, timePart, ampmRaw] = parts;
      const [d, m, y] = datePart.split("-").map(Number);
      let [h, min] = timePart.split(":").map(Number);
      const ampm = (ampmRaw || '').toLowerCase();
      if (ampm === "pm" && h !== 12) h += 12;
      if (ampm === "am" && h === 12) h = 0;
      return new Date(y, m - 1, d, h, min);
    }

    function formatDateOnly(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function getUnique(arr) {
      return Array.from(new Set(arr));
    }

    function groupBy(arr, keyFn) {
      const map = new Map();
      for (const item of arr) {
        const key = keyFn(item);
        if (!map.has(key)) map.set(key, []);
        map.get(key).push(item);
      }
      return map;
    }

    // ========================================
    // TRADING LEVELS CALCULATION
    // ========================================
    function calculateLevels(price, mode) {
      const p = parseFloat(price);
      if (isNaN(p) || p <= 0) return null;
      
      let slPercent, rrRatio;
      
      if (mode === 'intraday') {
        slPercent = 0.02; // 2% SL
        rrRatio = 2.0;     // 1:2 R:R
      } else if (mode === 'swing') {
        slPercent = 0.03; // 3% SL
        rrRatio = 2.5;     // 1:2.5 R:R
      } else {
        slPercent = 0.05; // 5% SL
        rrRatio = 3.0;     // 1:3 R:R
      }
      
      const sl = p * (1 - slPercent);
      const risk = p - sl;
      const target = p + (risk * rrRatio);
      
      return {
        entry: p.toFixed(2),
        sl: sl.toFixed(2),
        target: target.toFixed(2),
        rr: rrRatio.toFixed(1)
      };
    }

    // ========================================
    // DATA PREPROCESSING
    // ========================================
    function preprocessRaw(json) {
      const rows = [];
      for (const r of json) {
        const dt = parseCustomDate(r.date);
        if (!dt) continue;
        
        const date_only = formatDateOnly(dt);
        const hour = dt.getHours();
        
        // Extract price from various possible fields
        let price = r.close || r.Close || r.ltp || r.LTP || r.price || r.Price || '0';
        if (typeof price === 'string') {
          price = price.replace(/[‚Çπ,\s]/g, '').trim();
        }
        
        rows.push({
          ...r,
          _dt: dt,
          _dateOnly: date_only,
          _hour: hour,
          symbol: r.symbol || r.Symbol || 'N/A',
          sector: r.sector || r.Sector || 'Other',
          marketcapname: (r.marketcapname || r.marketCapName || 'Unknown').trim(),
          price: price
        });
      }
      
      rows.sort((a, b) => a._dt - b._dt);
      state.raw = rows;
      state.dates = getUnique(rows.map(r => r._dateOnly));
      
      console.log(`Preprocessed ${rows.length} rows across ${state.dates.length} trading days`);
    }

    // ========================================
    // AGGREGATION LOGIC
    // ========================================
    function aggregateIntraday() {
      const rows = state.raw;
      if (!rows.length) return [];
      
      const lastDate = state.dates[state.dates.length - 1];
      const subset = rows.filter(r => r._dateOnly === lastDate);
      const bySymbol = groupBy(subset, r => r.symbol);

      const result = [];
      for (const [symbol, list] of bySymbol.entries()) {
        const hours = getUnique(list.map(r => r._hour));
        const hits_1h = hours.length;
        const buckets = new Set();
        for (const h of hours) {
          const bucket = Math.floor((h - 9) / 4);
          buckets.add(bucket);
        }
        const hits_4h = buckets.size;
        const sample = list[list.length - 1];
        
        result.push({
          symbol,
          sector: sample.sector,
          marketcapname: sample.marketcapname,
          price: sample.price,
          hits_1h,
          hits_4h,
          total_hits: hits_1h + hits_4h
        });
      }
      
      return result.sort((a, b) => b.total_hits - a.total_hits);
    }

    function aggregateSwing(daysBack = 3) {
      const rows = state.raw;
      if (!rows.length) return [];
      
      const uniqueDates = state.dates;
      const lastDates = uniqueDates.slice(-daysBack);
      if (!lastDates.length) return [];

      const bySymbol = groupBy(
        rows.filter(r => lastDates.includes(r._dateOnly)),
        r => r.symbol
      );

      const result = [];
      for (const [symbol, list] of bySymbol.entries()) {
        const sample = list[list.length - 1];
        const byDate = groupBy(list, r => r._dateOnly);
        
        const hits_3d = lastDates.reduce((acc, d) => acc + ((byDate.get(d) || []).length), 0);
        
        let consec = 0;
        for (let i = lastDates.length - 1; i >= 0; i--) {
          const d = lastDates[i];
          const count = (byDate.get(d) || []).length;
          if (count > 0) consec += 1;
          else break;
        }

        result.push({
          symbol,
          sector: sample.sector,
          marketcapname: sample.marketcapname,
          price: sample.price,
          hits_3d,
          consec_days: consec
        });
      }

      return result.sort((a, b) => b.hits_3d - a.hits_3d);
    }

    function aggregatePositional() {
      const rows = state.raw;
      if (!rows.length) return [];
      
      const uniqueDates = state.dates;
      if (!uniqueDates.length) return [];

      const last15 = uniqueDates.slice(-15);
      const bySymbol = groupBy(
        rows.filter(r => last15.includes(r._dateOnly)),
        r => r.symbol
      );

      const result = [];
      for (const [symbol, list] of bySymbol.entries()) {
        const sample = list[list.length - 1];
        const byDate = groupBy(list, r => r._dateOnly);
        
        const hits_15d = last15.reduce((acc, d) => acc + ((byDate.get(d) || []).length), 0);
        
        const lastForTrend = last15.slice(-10);
        let daysInTrend = 0;
        for (const d of lastForTrend) {
          if ((byDate.get(d) || []).length > 0) daysInTrend++;
        }

        result.push({
          symbol,
          sector: sample.sector,
          marketcapname: sample.marketcapname,
          price: sample.price,
          hits_15d,
          days_in_trend: daysInTrend
        });
      }

      return result.sort((a, b) => b.hits_15d - a.hits_15d);
    }

    function recomputeAggregates() {
      state.aggregates.intraday = aggregateIntraday();
      state.aggregates.swing = aggregateSwing(3);
      state.aggregates.positional = aggregatePositional();
      
      console.log('Aggregates:', {
        intraday: state.aggregates.intraday.length,
        swing: state.aggregates.swing.length,
        positional: state.aggregates.positional.length
      });
    }

    // ========================================
    // FILTERING
    // ========================================
    function getFilteredData() {
      let data = state.aggregates[state.mode] || [];
      
      // Market cap filter
      if (state.selectedMcap !== 'all') {
        data = data.filter(row => {
          const mcap = (row.marketcapname || '').toLowerCase();
          return mcap.includes(state.selectedMcap.toLowerCase());
        });
      }
      
      return data;
    }

    // ========================================
    // SORTING
    // ========================================
    function sortBy(field) {
      if (state.sortField === field) {
        state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        state.sortField = field;
        state.sortDirection = 'desc';
      }
      renderTable();
    }

    function applySorting(data) {
      if (!state.sortField) return data;
      
      return [...data].sort((a, b) => {
        let aVal = a[state.sortField];
        let bVal = b[state.sortField];
        
        if (state.sortField === 'price') {
          aVal = parseFloat(aVal) || 0;
          bVal = parseFloat(bVal) || 0;
        } else if (state.sortField === 'hits') {
          aVal = a.total_hits || a.hits_3d || a.hits_15d || 0;
          bVal = b.total_hits || b.hits_3d || b.hits_15d || 0;
        } else if (typeof aVal === 'string') {
          aVal = aVal.toUpperCase();
          bVal = (bVal || '').toUpperCase();
        }
        
        if (state.sortDirection === 'asc') {
          return aVal > bVal ? 1 : -1;
        } else {
          return aVal < bVal ? 1 : -1;
        }
      });
    }

    // ========================================
    // RENDERING
    // ========================================
    function renderSummary() {
      const data = getFilteredData();
      const total = data.length;
      
      let summary = {
        total: total,
        sectors: getUnique(data.map(r => r.sector)).length,
        avgPrice: 0
      };
      
      if (total > 0) {
        const prices = data.map(r => parseFloat(r.price) || 0).filter(p => p > 0);
        summary.avgPrice = (prices.reduce((a, b) => a + b, 0) / prices.length).toFixed(0);
      }
      
      const grid = document.getElementById('summaryGrid');
      grid.innerHTML = `
        <div class="stat-box">
          <div class="stat-label">Total Signals</div>
          <div class="stat-value">${summary.total}</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Unique Sectors</div>
          <div class="stat-value">${summary.sectors}</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Avg Entry Price</div>
          <div class="stat-value">‚Çπ${summary.avgPrice}</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Strategy</div>
          <div class="stat-value" style="font-size:1.2rem;text-transform:capitalize;">${state.mode}</div>
        </div>
      `;
    }

    function renderTable() {
      let data = getFilteredData();
      data = applySorting(data);
      
      const tbody = document.getElementById('tableBody');
      
      if (!data.length) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;color:#9ca3af;">No signals match your filters</td></tr>';
        return;
      }
      
      const rows = data.map(row => {
        const levels = calculateLevels(row.price, state.mode);
        if (!levels) return '';
        
        const tvUrl = `https://in.tradingview.com/chart/?symbol=NSE:${encodeURIComponent(row.symbol)}`;
        
        // Color code R:R ratio
        let rrClass = 'pill-green';
        const rr = parseFloat(levels.rr);
        if (rr < 1.5) rrClass = 'pill-red';
        else if (rr < 2) rrClass = 'pill-yellow';
        
        // Get hit count based on mode
        let hits = 0;
        if (state.mode === 'intraday') hits = row.total_hits;
        else if (state.mode === 'swing') hits = row.hits_3d;
        else hits = row.hits_15d;
        
        return `<tr>
          <td><a href="${tvUrl}" target="_blank" class="symbol-link">${row.symbol}</a></td>
          <td style="font-size:0.8rem">${row.sector}</td>
          <td style="font-size:0.8rem">${row.marketcapname}</td>
          <td class="price-cell">‚Çπ${levels.entry}</td>
          <td class="sl-cell">‚Çπ${levels.sl}</td>
          <td class="target-cell">‚Çπ${levels.target}</td>
          <td><span class="pill ${rrClass}">${levels.rr}:1</span></td>
          <td style="font-weight:700">${hits}</td>
        </tr>`;
      }).filter(Boolean).join('');
      
      tbody.innerHTML = rows;
      
      // Update status banner
      const banner = document.getElementById('statusBanner');
      banner.innerHTML = `<span>‚óè</span> Showing <span class="highlight">${data.length}</span> signals | 
                          Total data: <span class="highlight">${state.raw.length}</span> rows | 
                          Trading days: <span class="highlight">${state.dates.length}</span>`;
      
      renderSummary();
    }

    // ========================================
    // USER INTERACTIONS
    // ========================================
    function filterByMcap(mcap) {
      state.selectedMcap = mcap;
      
      // Update button styles
      document.querySelectorAll('.mcap-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      renderTable();
    }

    function switchMode(mode) {
      state.mode = mode;
      
      // Update tab styles
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Update card title
      const titles = {
        intraday: 'Intraday Trading Signals (1h / 4h)',
        swing: 'Swing Trading Signals (1-3 Days)',
        positional: 'Positional Trading Signals (5-15 Days)'
      };
      document.getElementById('cardTitle').textContent = titles[mode];
      
      renderTable();
    }

    // ========================================
    // DATA LOADING
    // ========================================
    async function loadData() {
      const banner = document.getElementById('statusBanner');
      
      try {
        banner.innerHTML = '<span>‚óè</span> Loading data from cloud...';
        
        const res = await fetch('data.json', { cache: 'no-cache' });
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        
        const json = await res.json();
        
        if (!json || json.length === 0) {
          banner.innerHTML = '<span style="color:#facc15">‚ö†</span> No data available. Run autoupload.py to populate dashboard.';
          return;
        }
        
        preprocessRaw(json);
        recomputeAggregates();
        renderTable();
        
        console.log('‚úÖ Data loaded successfully');
        
      } catch (err) {
        console.error('Load error:', err);
        banner.innerHTML = `<span style="color:#f97373">‚úó</span> Error loading data: ${err.message}. Make sure autoupload.py is running.`;
      }
    }

    // ========================================
    // INITIALIZATION
    // ========================================
    window.addEventListener('DOMContentLoaded', () => {
      console.log('Dashboard initialized');
      loadData();
      
      // Auto-refresh every 30 seconds
      setInterval(loadData, 30000);
    });
  </script>
</body>
</html>
